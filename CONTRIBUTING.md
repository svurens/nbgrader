# Contributing to nbgrader

We're thrilled you want to help contribute to nbgrader!
This document gives an overview of how various parts of the project work and what our expectations are for contributions.

In general, the guidelines for opening issues, submitting PRs, code style, etc. are the same as the [IPython contribution guidelines](https://github.com/ipython/ipython/blob/master/CONTRIBUTING.md).

## Preliminary IPython installation

Before installing the other dependencies of nbgrader, please ensure that IPython Notebooks are properly installed.

If using conda, run

    conda install ipython-notebook

Otherwise, run

    pip install ipython[notebook]

## Development installation

To develop and test nbgrader, you will want to install nbgrader using the development requirements:

    pip install -r dev-requirements.txt -e .

You will probably also want to install the notebook extension only for yourself, and using a symlink, so that it updates whenever you update the repository:

    nbgrader extension install --user --symlink
    nbgrader extension activate

Phantomjs must be installed in order to run tests. If you have npm installed, you can install phantomjs using:
    
    npm install phantomjs

If you do not have npm installed, you can still install phantomjs. On OS X:

    brew update
    brew install phantomjs

On Linux:

    apt-get update
    apt-get install phantomjs

## Pull request checklist

Before making a pull request, please ensure you have:

* Added or updated relevant documentation, if applicable.
* Added new tests, if applicable (*especially* if this is a major change or a bugfix, in which case there should be a regression test).
* Run the full test suite locally.

## Testing

Before making a PR, please run the test suite locally and make sure everything passes.
We have automatic tests on Travis CI, but they take a long time to run and sometimes randomly time out, so it will be much more efficient if you can test locally first.
To run the full test suite, run the following command from the root of the repository:

    invoke tests

To run only the tests for the Python code, run `invoke tests --group=python`.
To run only the JavaScript tests (e.g. for the notebook extension and the formgrader), run `invoke tests --group=js`.
Note that if you are using Python 3, some of the JavaScript tests will expect that [JupyterHub](https://github.com/jupyter/jupyterhub) is installed.
If you don't want or need to run the JupyterHub tests, you can run the invoke command with `--skip=jupyterhub`.
If you want to choose an even more specific subset of tests, you should invoke `py.test` directly.
For example, to run only the tests for `nbgrader assign`:

    py.test nbgrader/tests/apps/test_nbgrader_assign.py

## Editing and building documentation

### Editing

The source for the documentation can be found in the [docs/source](docs/source) directory of this repository.
These source files are a combination of ReStructured Text (rst) and Jupyter notebooks.

* The rst files for the should be fairly straightforward to edit; if it's helpful, here is [a quick reference of rst syntax](http://docutils.sourceforge.net/docs/user/rst/quickref.html).
Some of the rst files also use [Sphinx autodoc](http://sphinx-doc.org/ext/autodoc.html).
* The Jupyter notebooks are written in Python and should be written so that they are compatible with both Python 2 and Python 3.
In addition, if you need to reference another part of the documentation from a notebook, you will need to put that reference in a raw cell in the notebook, **not** a markdown cell.

If you add a new file (either rst or ipynb) make sure to link to it from the relevant `index.rst`.
Additionally, if you are adding a new notebook in the user guide, please add the rst version of it to [.gitignore](.gitignore).
**Never** commit any documentation that is automatically generated.

Before you commit your changes, you must clear the Jupyter notebooks so that they don't have any output or metadata associated with them (the output should be cleared because it tends to cause merge conflicts, and the metadata should be cleared so the notebooks can run under either Python 2 or Python 3).
To clear the notebooks, as well as any autogenerated files, please run the following command from the root of the repository:

    invoke clear_docs

If you are making major changes to the docs, please build them locally to verify that they look ok (see the next section).
If you are making only minor changes, it is fine to make a PR without building them locally.
You will, however, still need to run `invoke clear_docs` or the Travis CI build will fail.

### Building locally

Our docs are built with [nbconvert](http://nbconvert.readthedocs.org/en/latest/), [Pandoc](http://pandoc.org/), and [Sphinx](http://sphinx-doc.org/).
There are two steps to building the docs locally.

First, the notebooks must be executed and converted to rst or html (the actual documentation notebooks will be converted to rst, and example notebooks will be converted to html).
To do this, run the following command from the root of the repository (make sure you have cleared the docs first, too):

    invoke docs

Second, the rst files must be converted to html using Sphinx.
This is different from the html produced by `nbconvert` in the previous step, as it includes more complicated operations such as automatically generating API docs from docstring, creating links between docs, etc.
To generate the Sphinx docs, run the following command from the root of the repository:

    invoke sphinx

This will produce HTML files in `docs/build/html`.
You can open these files in your browser to preview what the documentation will look like (note, however, that the theme used by Read The Docs is different from the default Sphinx theme, so the styling will look different).

### Automatic builds

When a commit is made on the `master` branch, documentation is automatically built in two steps:

1. Travis CI will perform the step of `invoke docs` and automatically commit the results to the `docs` branch of this repository.
2. Read The Docs will perform the step of building the Sphinx documentation, and render it at [nbgrader.readthedocs.org](http://nbgrader.readthedocs.org)

## JavaScript dependencies

For the time being, we are committing JavaScript dependencies to the repository as that makes installation much easier.
If you need to add a new library, or update the version of a library, you will need to have `npm` installed.
To install npm on OS X, use Homebrew to install node (npm will be installed along with node):

    brew update
    brew install node

To install npm on Linux with apt-get, use:

    apt-get update
    apt-get install node
    apt-get install npm

Modify the [bower.json](bower.json) file in the root of the repository and then run:

    invoke js

This will download and install the correct versions of the dependencies to [nbgrader/html/static/components](nbgrader/html/static/components).
Usually, JavaScript libraries installed in this way include a lot of extra files that we don't want to commit to the nbgrader repository (e.g. tests, documentation).
If this is the case, please add these files to the [.gitignore](.gitignore) file so they don't get committed.
